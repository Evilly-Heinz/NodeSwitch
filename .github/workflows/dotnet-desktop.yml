# CI for NodeSwitch: build, test, collect and upload built executable (NodeSwitch.exe)
# - This workflow builds the solution, finds any NodeSwitch.exe produced in the bin folders,
#   copies them into a known artifacts directory and uploads that directory.
# - This is robust even if dotnet publish or AppPackages are not produced.
# - MSIX packaging remains optional and disabled by default.

name: .NET Core Desktop (NodeSwitch)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        configuration: [Debug, Release]

    env:
      Solution_Name: NodeSwitch
      # packaging project path (if you have a .wapproj, set it here)
      Wap_Project_Path: NodeSwitch\NodeSwitch.csproj
      # set to 'true' only if you have a packaging project and the signing secrets
      BUILD_MSIX: 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore solution (MSBuild Restore)
        run: msbuild $env:Solution_Name /t:Restore /p:Configuration=${{ matrix.configuration }}
        env:
          Configuration: ${{ matrix.configuration }}

      - name: Build solution
        run: msbuild $env:Solution_Name /t:Build /p:Configuration=${{ matrix.configuration }} /m
        env:
          Configuration: ${{ matrix.configuration }}

      - name: Execute unit tests
        run: dotnet test --no-build -c ${{ matrix.configuration }} || Write-Host "Tests failed or no tests"

      # Optional: attempt dotnet publish as a canonical publish output (may be unused)
      - name: Attempt dotnet publish (optional)
        run: |
          dotnet publish NodeSwitch/NodeSwitch.csproj -c ${{ matrix.configuration }} -r win-x64 --self-contained false -o $GITHUB_WORKSPACE/artifacts/publish/${{ matrix.configuration }} || Write-Host "Publish may have not produced outputs"

      # Debug listing of the project bin/release folders to help diagnose locations
      - name: Show bin outputs (project)
        run: |
          Write-Host "Listing bin/ and relevant project folders under NodeSwitch/NodeSwitch:"
          if (Test-Path "NodeSwitch/NodeSwitch") {
            Get-ChildItem -Path "NodeSwitch/NodeSwitch" -Recurse -Force | Where-Object { $_.FullName -match '\\bin\\|\\obj\\' } | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "Project folder NodeSwitch/NodeSwitch not found"
          }

      # Collect NodeSwitch.exe (search & copy into artifacts directory)
      - name: Collect built NodeSwitch.exe into artifacts directory
        run: |
          $config = '${{ matrix.configuration }}'
          $workspace = "$env:GITHUB_WORKSPACE"
          Write-Host "GITHUB_WORKSPACE = $workspace"
          Write-Host "Searching for NodeSwitch.exe under $workspace ..."
          $matches = Get-ChildItem -Path $workspace -Filter 'NodeSwitch.exe' -Recurse -ErrorAction SilentlyContinue
          if (!$matches -or $matches.Count -eq 0) {
            Write-Host "No NodeSwitch.exe found under the workspace."
            exit 0
          }
          $dest = Join-Path -Path $workspace -ChildPath ("artifacts/binaries/$config")
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          foreach ($f in $matches) {
            $target = Join-Path $dest $f.Name
            Copy-Item -Path $f.FullName -Destination $target -Force
            Write-Host "Copied $($f.FullName) -> $target"
          }
          Write-Host 'Done copying executables.'

      # Show what we will upload
      - name: Show artifacts directory
        run: |
          Write-Host "Listing artifacts directory:"
          if (Test-Path "$GITHUB_WORKSPACE/artifacts") {
            Get-ChildItem -Path "$GITHUB_WORKSPACE/artifacts" -Recurse -Force | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "No artifacts directory present"
          }

      # Upload the collected binaries (this will upload any NodeSwitch.exe we copied)
      - name: Upload collected binaries
        uses: actions/upload-artifact@v4
        with:
          name: NodeSwitch-binaries
          path: artifacts/binaries/**

      # If you need MSIX packaging, keep these steps and set BUILD_MSIX = 'true' and secrets
      - name: Decode the pfx (for MSIX signing)
        if: env.BUILD_MSIX == 'true'
        run: |
          if (-not ${{ secrets.Base64_Encoded_Pfx }}) { Write-Host 'Missing Base64_Encoded_Pfx secret'; exit 1 }
          $pfx_cert_byte = [System.Convert]::FromBase64String("${{ secrets.Base64_Encoded_Pfx }}")
          $certificatePath = Join-Path -Path (Join-Path $GITHUB_WORKSPACE 'NodeSwitch') -ChildPath 'GitHubActionsWorkflow.pfx'
          [IO.File]::WriteAllBytes("$certificatePath", $pfx_cert_byte)
          Write-Host "Wrote certificate to $certificatePath"

      - name: Create the app package (MSIX)
        if: env.BUILD_MSIX == 'true'
        run: msbuild $env:Wap_Project_Path /p:Configuration=${{ matrix.configuration }} /p:UapAppxPackageBuildMode=StoreUpload /p:AppxBundle=Always /p:PackageCertificateKeyFile=GitHubActionsWorkflow.pfx /p:PackageCertificatePassword=${{ secrets.Pfx_Key }}
        env:
          Configuration: ${{ matrix.configuration }}

      - name: Upload MSIX / AppPackages (if created)
        if: env.BUILD_MSIX == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: MSIX Package
          path: |
            "NodeSwitch/AppPackages/**"
            "**/*.msix"
            "**/*.msixbundle"
            "**/*.appx"
