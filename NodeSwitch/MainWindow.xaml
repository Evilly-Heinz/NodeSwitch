<controls:MicaWindow  x:Class="NodeSwitch.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:tb="http://www.hardcodet.net/taskbar" 
        xmlns:viewmodels="clr-namespace:NodeSwitch.ViewModels" 
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="clr-namespace:MicaWPF.Controls;assembly=MicaWPF"
        StateChanged="Window_StateChanged"
        Title="Node Version Switcher" Height="500" Width="800" 
        >
    <controls:MicaWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </controls:MicaWindow.Resources>
    <Grid>
        <Grid Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="4*" />
                <ColumnDefinition Width="5*" />
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Use a Grid instead of StackPanel to allow ListBox to stretch and avoid overflow -->
            <Grid Grid.Column="0" Margin="10 5 15 5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <TextBlock Text="Installed Versions" FontWeight="Bold" FontSize="16"/>
                <!-- Search box for Installed Versions -->
                <controls:TextBox Grid.Row="1"
                     VerticalAlignment="Top"
                      Margin="0,10"
                     Text="{Binding InstalledSearchText, UpdateSourceTrigger=PropertyChanged}"
                      />
                <ListBox Grid.Row="2"
                     ItemsSource="{Binding FilteredInstalledVersions}" 
                     Margin="0,0,0,0"
                     VerticalAlignment="Stretch"
                     BorderThickness="0"
                     Background="Transparent"
                     ScrollViewer.VerticalScrollBarVisibility="Auto">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Background" Value="Transparent" />
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Background="Transparent">
                            </StackPanel>
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid HorizontalAlignment="Stretch" Width="Auto" Background="Transparent" >
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding Version}" HorizontalAlignment="Stretch"
                                           Foreground="{StaticResource ResourceKey=MicaWPF.Brushes.TextFillColorPrimary}"
                                           Margin="10" FontSize="14"/>
                                <controls:Button Grid.Column="1" Content="Use" 
                                    Padding="20 5"
                                    Command="{Binding DataContext.UseCommand, RelativeSource={RelativeSource AncestorType=ListBox}}" 
                                    CommandParameter="{Binding Version}"
                                    Visibility="{Binding Visibility}" />
                                <controls:Button Grid.Column="2" Content="Uninstall" 
                                    Command="{Binding DataContext.UninstallCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                    CommandParameter="{Binding Version}" 
                                    Margin="10, 0"
                                    Padding="20 5"/>
                                <Border
                                        Grid.ColumnSpan="3"
                                        VerticalAlignment="Bottom"
                                        CornerRadius="8"
                                        BorderThickness="0 0 0 1"
                                        Margin="0 0 0 0"
                                        >
                                    <Border.BorderBrush>
                                        <LinearGradientBrush>
                                            <GradientStop Offset="0.0" Color="Transparent" />
                                            <GradientStop Offset="0.1" Color="{StaticResource MicaWPF.Colors.ControlStrokeColorDefault}" />
                                            <GradientStop Offset="0.9" Color="{StaticResource MicaWPF.Colors.ControlStrokeColorDefault}" />
                                            <GradientStop Offset="1.0" Color="Transparent" />
                                        </LinearGradientBrush>
                                    </Border.BorderBrush>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>

            <Grid Grid.Column="1" Margin="15 5 10 5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <TextBlock Text="Available Versions" FontWeight="Bold" FontSize="16"/>
                <!-- Search box for Available Versions -->
                <controls:TextBox Grid.Row="1"
                      Margin="0,10" 
                     VerticalAlignment="Center"
                     Text="{Binding AvailableSearchText, UpdateSourceTrigger=PropertyChanged}"
                     />
                <ListBox Grid.Row="2"
                     ItemsSource="{Binding FilteredAvailableVersions}" 
                     Margin="0,0,0,0"
                     VerticalAlignment="Stretch"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     BorderThickness="0"
                     Background="Transparent"
                     IsEnabled="{Binding IsInstalling, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=False}">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid HorizontalAlignment="Stretch" Width="Auto" >
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding}" HorizontalAlignment="Stretch" Margin="10" FontSize="14"
                                           VerticalAlignment="Center"
                                           Foreground="{StaticResource ResourceKey=MicaWPF.Brushes.TextFillColorPrimary}"/>
                                <controls:Button Grid.Column="1" Content="Install"
                                                 VerticalAlignment="Center"
                                    Padding="20 5" 
                                    Command="{Binding DataContext.InstallCommand, RelativeSource={RelativeSource AncestorType=ListBox}}" 
                                    CommandParameter="{Binding}"
                                    IsEnabled="{Binding DataContext.IsInstalling, RelativeSource={RelativeSource AncestorType=ListBox}, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=False}" />
                                <Border
                                    Grid.ColumnSpan="2"
                                    VerticalAlignment="Bottom"
                                    CornerRadius="8"
                                    BorderThickness="0 0 0 1"
                                    Margin="0 0 0 0"
                                    >
                                    <Border.BorderBrush>
                                        <LinearGradientBrush>
                                            <GradientStop Offset="0.0" Color="Transparent" />
                                            <GradientStop Offset="0.1" Color="{StaticResource MicaWPF.Colors.ControlStrokeColorDefault}" />
                                            <GradientStop Offset="0.9" Color="{StaticResource MicaWPF.Colors.ControlStrokeColorDefault}" />
                                            <GradientStop Offset="1.0" Color="Transparent" />
                                        </LinearGradientBrush>
                                    </Border.BorderBrush>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>

            <!-- ProgressBar shown during installation -->
            <ProgressBar Grid.Row="2"
              Height="20"
              Margin="0,10,0,0"
              Minimum="0"
              Maximum="100"
                     Grid.ColumnSpan="2"
              IsIndeterminate="True"
              Visibility="{Binding IsInstalling, Converter={StaticResource BooleanToVisibilityConverter}}"/>
        </Grid>

        <tb:TaskbarIcon x:Name="TrayIcon"
                IconSource="pack://application:,,,/Resources/nodejs.ico"
                ToolTipText="WPF NotifyIcon Example"
                Visibility="Collapsed" MenuActivation="RightClick"
                >
            <tb:TaskbarIcon.ContextMenu>
                <ContextMenu ItemsSource="{Binding InstalledVersions}">
                    <ContextMenu.ItemContainerStyle>
                        <Style TargetType="MenuItem">
                            <Setter Property="Header" Value="{Binding Version}" />
                            <Setter Property="Icon" >
                                <Setter.Value>
                                    <TextBlock Text="✔️" Visibility="{Binding IsActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="Command" Value="{Binding DataContext.UseCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"  />
                            <Setter Property="CommandParameter" Value="{Binding Version}" />
                        </Style>
                    </ContextMenu.ItemContainerStyle>
                </ContextMenu>
            </tb:TaskbarIcon.ContextMenu>

        </tb:TaskbarIcon>
    </Grid>

</controls:MicaWindow  >